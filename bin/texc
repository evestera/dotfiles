#!/usr/bin/env python

import subprocess
import argparse
import logging
import os
import re
import sys

def main(arguments):
    parser = argparse.ArgumentParser(description='Compile a LaTeX document')
    parser.add_argument('file',
        help='file to compile')
    parser.add_argument('-v', '--verbose', action='store_true',
        help='print way too much stuff')
    parser.add_argument('-k', '--keep', action='store_true',
        help='keep all generated files (.aux, .log, etc)')
    parser.add_argument('-m', '--minted', action='store_true',
        help='use minted for code snippets')

    args = parser.parse_args(arguments)

    logging.basicConfig(format='%(module)s - %(funcName)s - %(message)s')
    if args.verbose:
        logging.getLogger().setLevel(logging.DEBUG)

    inpath, extension = os.path.splitext(args.file)
    texfile = os.path.abspath(args.file)
    os.chdir(os.path.dirname(texfile))

    if not os.path.isfile(texfile):
        print 'No such file: ' + args.file
        return

    initialfiles = set(os.listdir('.'))

    command = ['lualatex']
    command += ['-file-line-error']
    if args.minted:
        command += ['-shell-escape']
    command += ['--jobname', os.path.basename(inpath)]
    command += [texfile]

    logging.debug('Running pdflatex: ' + str(command))
    proc = subprocess.Popen(command,
        stdin=subprocess.PIPE,
        stdout=subprocess.PIPE,
        stderr=subprocess.STDOUT)

    stdout, stderr = proc.communicate()
    errors = re.findall('(.*?):(.*?): ([^.!]*)', stdout)

    logging.debug(stdout)

    if len(errors) > 0:
        print 'Compilation ended with {0} errors:'.format(len(errors))
        linecols = str(max(map(lambda x: len(x[1]), errors)))
        for error in errors:
            print ('Error on line {line:>' + linecols + '} of {file}: {err}').format(
                file = os.path.relpath(error[0]),
                line = error[1],
                err = error[2].replace('\n', ''))
    else:
        print 'Compilation finished with no errors'

    finalfiles = set(os.listdir('.'))
    newfiles = finalfiles - initialfiles
    if not args.keep:
        for filename in filter(lambda x: not x.endswith('.pdf'), newfiles):
            logging.debug('Deleting file: ' + filename)
            os.remove(filename)

if __name__ == '__main__':
    main(sys.argv[1:])
